---
title: "Traffic stop missingness statistics"
author: "Amber Lee"
date: "10/19/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Libraries

```{r load libraries, message = FALSE}

library(RMySQL)

library(tidyverse)
library(tidyr)
library(broom) # make tidy the regression outputs
library(lubridate) # dates
library(stringr) # string manipulation
# library(tidycensus)
library(kableExtra) # make nice tables
library(ggrepel)
# library(geofacet)
# library(naniar) # replace "NA" with NA, except too slow, use baseR solution
# library(revgeo)
library(forcats) # reordering factors


 library(kableExtra) # save table as png
# library(patchwork)
# library(XML)
# library(RCurl)
# library(lutz)
# library(suncalc)
```


# Querying Data

```{r connect to sql, include = FALSE}

con <- dbConnect(
  MySQL(), host = "traffic.st47s.com", user = "student", 
  password = "Sagehen47", dbname = "traffic")

```

```{r query n% sample of all datasets}

dataset_names <- dbGetQuery(con, "SHOW TABLES")[[1]]

# remove datasets with "_" in the name
dataset_names <- dataset_names[str_detect(dataset_names, "_", negate = TRUE)]

query_sample <- function(dataset_str, percent){
  # input is dataset_str (str) with dataset name, and percent (dbl) for the random sample %
  # output is the dataframe with a column added for the name of dataset and character NA's
  # replaced with NA's
  # global variable con is the SQL connection
  
  command <- paste("SELECT * FROM", dataset_str, "WHERE rand() <=", percent, 
                   # in SQL, filter for vehicular stops
                   " AND type = 'vehicular'",
                   sep = " ")

  df <- dbGetQuery(con, command) %>% mutate(dataset_name = dataset_str)
  
  # do not consider empty datasets
  if (dim(df)[1] == 0){
    return(NULL)
  }
  
  # replace character NA's with NA
  if (sum(is.na(df) == 0)){
    
    df[df == "NA"] = NA

  }
  
  return(df %>% dplyr::select(-type))
  
}

dataset_lst <- lapply(dataset_names, query_sample, 0.3)

# remove empty datasets through logical indexing
dataset_lst <- dataset_lst[sapply(dataset_lst, function(x) isTRUE(nrow(x) > 0))]

```

# Cleaning data

Some columns are empty for all observations, so we want to remove them.

```{r}

check_nonempty <- function(var, dataset, n_obsv){
  # helper function for removing empty columns
    
  # the function environment has the parameter dataset
  col_str <- paste("dataset$", var, sep = "")
  col <- eval(parse(text = col_str))
  isCollected <- sum(is.na(col)) < n_obsv
  
  return(isCollected)
  
}

remove_empty_col <- function(dataset){
  # a variable is 'collected' if there is a column for it in the dataset
  # but being collected doesn't imply nonempty
  
  collected_var <- names(dataset)
  n_obsv <- dim(dataset)[1]
  
  nonempty_bools <- unlist(lapply(collected_var, check_nonempty, dataset, n_obsv))
  
  # use logial indexing!
  nonempty_var <- collected_var[nonempty_bools]
  
  ## in case i need this information
  # empty_var <- collected_var[!nonempty_bools]
  
  return(dataset %>% dplyr::select({{ nonempty_var }}))
  
}

dataset_lst <- lapply(dataset_lst, remove_empty_col)

```


# Functions for manipulating a list of dataframes

`myfilter_for` can be thought of as -- I have a list of dataframes, and I am *filtering for* these particular variables in each dataframe. If I *need containment*, then I only look for the dataframes with ALL of the variables in  `var_vect`. 

```{r}

myfilter_for <- function(dataset, var_vect, need_containment){
  # if need_containment is true, then function only returns
  # datasets containing ALL variables specified in var_vect
  
  # need_containment = TRUE results in more restrictive filtering
  
  dataset_var <- names(dataset)
  intersection <- var_vect[var_vect %in% dataset_var]
  
  if (need_containment){
    
    if (length(intersection) == length(var_vect)) {
      # embrace syntax from dplyr programming
      return(dataset %>% dplyr::select({{ var_vect }}))
    } else {
      return(NULL)
    }
    
  } else if (!need_containment){
    
    if (length(intersection > 0)) {
      # embrace syntax from dplyr programming
      return(dataset %>% dplyr::select({{ intersection }}))
    } else{
      return(NULL)
    }
    
  }
  
}

```

```{r countMissing}

check_missing <- function(n_threshold, df){
  
  col <- df %>% 
    mutate("isMissing_{{ n_threshold }}" := case_when(missing >= n_threshold ~ TRUE,
                                                TRUE ~ FALSE)) %>%
    select(starts_with("isMissing"))

  return(col)

}

countMissing <- function(dataset, n_threshold, exclude_bool, exclude_var){
  # <n_threshold> is used to classify the observations with
  # at least n_threshold missing values as completely missing
  
  # <exclude_var> is str specifying which variables we don't count for NA's

  n_var <- dim(dataset)[2]
  
  if (exclude_bool){
    missing <- list(missing = rowSums(is.na(dataset %>% select(-all_of(exclude_var)))))
    
  } else {
    missing <- list(missing = rowSums(is.na(dataset)))
    
  }
  
  dataset <- dataset %>%
    bind_cols(list(missing), .id = NULL) %>% 
    mutate(stop_missing_rate = missing/n_var)
  
  dataset <- dataset %>%
    # check_missing operates on dataset with missingness already counted
    bind_cols(lapply(1:n_threshold, check_missing, dataset))
 
  return(as.data.frame(dataset))

}

```

```{r dataset containing}

dataset_containing <- function(dataset, var_vect){
  # var_vect is str with the variables we WANT
  # returns the whole dataset
  
  if(var_vect %in% names(dataset)){
    return(dataset)
    
  } else {
    return(NULL)
    
  }
  
}

```


# Visualizations for About the Data Section

```{r}
# 15 most frequently recorded variables
freq_var <- data.frame("var" = unlist(lapply(dataset_lst, function(dataset) names(dataset)))) %>%
  group_by(var) %>%
  summarize(count = n(), .groups = "drop") %>%
  # drop type (either pedestrian or vehicular)
  filter(var != "type" & str_detect(var, "row", negate = TRUE)) %>%
  # n = 16 because dataset_name is a variable
  slice_max(count, n = 16) %>%
  pull(var)

freq_dataset_lst <- lapply(dataset_lst, myfilter_for, freq_var, FALSE)

```

```{r}
all_var <- unlist(map(dataset_lst, names))

all_var <- all_var[str_detect(all_var, "row|dataset|raw", negate = TRUE)] 

all_var <- data.frame(all_var) %>%
  group_by(all_var) %>%
  summarize(count = n()) 

all_var_subset <- all_var %>%
  filter(all_var == "citation_issued" | 
           all_var == "vehicle_registration_state" |
           all_var == "contraband_alcohol" )
# 
# freq_var_subset <- all_var %>%
#   filter(all_var %in% freq_var)

ggplot(data = all_var) +
  geom_boxplot(aes(y = count)) +
  geom_point(data = all_var_subset, aes(x = 0, y = count, 
                                        color = as.factor(count))) +
  geom_label_repel(data = all_var_subset, aes(label = paste(all_var, "\n", count, "datasets"), x = 0, y = count, color = as.factor(count)), box.padding = 5, segment.color = 'grey50') +
#  theme_classic() +
  coord_flip() +
  ylim(-10, 65) +
  xlim(-2, 2) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.position = "none") +
  ylab("Datasets") +
  ggtitle("Variables recorded 66 traffic stop datasets")

ggsave("fig/var_dist.png")
  
# title is not very descriptive

# ggplot(data = all_var) +
#   geom_boxplot(aes(y = count)) +
#   geom_point(data = freq_var_subset, aes(x = 0, y = count, 
#                                         color = as.factor(count))) +
# #  theme_classic() +
#   coord_flip() +
#   ylim(-10, 65) +
#   xlim(-2, 2) +
#   theme(axis.title.y=element_blank(),
#         axis.text.y=element_blank(),
#         axis.ticks.y=element_blank(),
#         legend.position = "none") +
#   ylab("Datasets") +
#   ggtitle("Variables recorded 66 traffic stop datasets")
```

```{r}
dataset_smr <- unlist(map(dataset_lst, function(x) sum(is.na(x))/(dim(x)[1]*dim(x)[2])))
dataset_sizes <- unlist(map(dataset_lst, function(x) dim(x)[1]*dim(x)[2]))
dataset_k <- unlist(map(dataset_lst, function(x) length(names(x))))
```

```{r}

dataset_stats <- data.frame(dataset_smr, dataset_sizes, dataset_k)
rm(dataset_smr, dataset_sizes, dataset_k)

boxplot(dataset_stats$dataset_sizes)

dataset_stats %>%
  ggplot() +
  geom_point(aes(x = dataset_k, y = dataset_smr,
                 size = sqrt((dataset_sizes)), color = log(dataset_sizes)), position = "jitter") +
  ggtitle("Dataset SMR and Number of Variables")
ggsave("fig/SMR_n_k.png")
# color and size variables kinda weird

```


## North Carolina 

```{r NC density plots}

NC_lst <- dataset_lst[sapply(dataset_lst, 
                             function(x) str_detect(x$dataset_name[1], "NC"))]


NC_lst <- lapply(NC_lst, function(x) x %>% 
                   select(subject_age, dataset_name) %>%
                   mutate(subject_age = as.numeric(subject_age)))

bind_rows(NC_lst) %>% 
  mutate(dataset_name = case_when(str_detect(dataset_name, "charlotte") ~ "Charlotte, NC",
                                  str_detect(dataset_name, "durham") ~ "Durham, NC",
                                  str_detect(dataset_name, "greensboro") ~ "Greensboro, NC",
                                  str_detect(dataset_name, "raleigh") ~ "Raleigh, NC")) %>%
  ggplot(aes(x = subject_age)) +
  geom_density(aes(color = dataset_name)) +
  facet_wrap(~ dataset_name)  +
  theme(legend.position = "none",
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  scale_x_continuous("Age") +
  labs(title = "Age densities for stopped drivers in North Carolina",
       subtitle = "O")
ggsave("fig/nc_age.png")

# fyi

# map(NC_lst, dim)
# # [[1]]
# # [1] 479827      2
# # 
# # [[2]]
# # [1] 98148     2
# # 
# # [[3]]
# # [1] 180306      2
# # 
# # [[4]]
# # [1] 256456      2
```

```{r}
rm(NC_lst, all_var, all_var_subset, dataset_stats)
```


# Visualizations for the Toy example (in Definitions section)

```{r}
set.seed(6)
dataset_lst[[4]] %>%
  select(subject_race, subject_sex, subject_age, search_conducted) %>%
  sample_n(4) %>%
  kable("latex", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "scale_down")) %>%
  save_kable("fig/toyoak.png")
```

# Visualizations

## Race

```{r}
makeDF.SMRByRace <- function(dataset_lst){
  # input: list of datasets
  
  #helper function
  summarizeSMRByRace <- function(dataset){
    # input: <dataset> with missingness counted
    
    count_race <- dataset %>% 
      group_by(subject_race) %>%
      summarize(count = n()) %>%
      mutate(labelled_race = case_when(subject_race == "black" ~ "Black",
                          subject_race == "hispanic" ~ "Hispanic",
                          subject_race == "asian/pacific islander" 
                          ~ "Asian/Pacific Islander",
                          subject_race == "white" ~ "White",
                          subject_race == "unknown" ~ "Unknown",
                          subject_race == "other" ~ "Other")) %>%
      select(-subject_race)
    
    dataset <- dataset %>%
      ungroup() %>%
      group_by(subject_race, dataset_name) %>%
      summarize(avg_SMR = mean(stop_missing_rate), .groups = "drop") %>%
      mutate(labelled_race = case_when(subject_race == "black" ~ "Black",
                                      subject_race == "hispanic" ~ "Hispanic",
                                      subject_race == "asian/pacific islander" 
                                      ~ "Asian/Pacific Islander",
                                      subject_race == "white" ~ "White",
                                      subject_race == "unknown" ~ "Unknown",
                                      subject_race == "other" ~ "Other")) %>%
      rename(`SMR` = avg_SMR) %>%
      select(labelled_race, `SMR`, dataset_name) %>%
      left_join(count_race, by = "labelled_race")
    
    return(dataset)
    
  }
  
  race_lst <- lapply(dataset_lst, dataset_containing, "subject_race")
  race_lst <- race_lst[sapply(race_lst, function(x) isTRUE(nrow(x) > 0))]
  
  race_lst <- lapply(race_lst, countMissing, 1, TRUE, "subject_race")
  
  # filter out and count erorrs
  race_df <- bind_rows(lapply(race_lst, summarizeSMRByRace)) 
  # %>%
  #   spread(key = isRecorded, value = avg_SMR)
  
  return(race_df)
  
}

# # this isn't apples to apples bc of different k in each dataset
# smrRace <- makeDF.SMRByRace(dataset_lst)
# 
# smrRace %>%
#   left_join(smrRace %>%
#               group_by(labelled_race) %>%
#               summarize(datasets = n(),
#                         sum = sum(count)),
#             by = "labelled_race") %>%
#   mutate(labelled_race = paste(labelled_race, "\n", "n = ", 
#                                prettyNum(signif(sum, 2),  big.mark=",", scientific=FALSE),
#                                sep = ""),
#          labelled_race = fct_reorder(labelled_race, sum)) %>%
#   ggplot() +
#   geom_boxplot(aes(x = labelled_race, y = SMR, group = labelled_race,
#                    color = log(sum))) +
#   coord_flip() +
#   theme(axis.title.y = element_blank(),
#         legend.position = "none") +
#   labs(title = "SMR by race",
#        subtitle = "57 datasets")
```

```{r}
# SMR for freq dataset 

freq_smrRace <- makeDF.SMRByRace(freq_dataset_lst)

freq_smrRace %>%
  left_join(freq_smrRace %>%
              group_by(labelled_race) %>%
              summarize(datasets = n(),
                        sum = sum(count)),
            by = "labelled_race") %>%
  mutate(labelled_race = paste(labelled_race, "\n", "n = ", 
                               prettyNum(signif(sum, 2),  big.mark=",", scientific=FALSE),
                               sep = ""),
         labelled_race = fct_reorder(labelled_race, sum)) %>%
  ggplot() +
  geom_boxplot(aes(x = labelled_race, y = SMR, group = labelled_race,
                   color = log(sum))) +
  coord_flip() +
  theme(axis.title.y = element_blank(),
        legend.position = "none") +
  labs(title = "SMR by race in 57 datasets")

ggsave("fig/SMR_by_race.png")

```


## Post-stop outcomes by race


```{r viz smr race plots}

p_asian_white <- freq_smrRace %>%
  pivot_wider(-count, names_from = labelled_race, values_from = SMR) %>%
  ggplot(aes(x = White, y = `Asian/Pacific Islander`)) +
  geom_point(size = 0.75) +
  geom_abline(color = 'grey50', alpha = 0.5) +
  scale_x_continuous("White", limits = c(0, 0.5)) +
  scale_y_continuous("Asian/Pacific Islander", limits = c(0, 0.5)) +
  theme(aspect.ratio = 1)

p_black_white <- freq_smrRace %>%
  pivot_wider(-count, names_from = labelled_race, values_from = SMR) %>%
  ggplot(aes(x = White, y = Black)) +
  geom_point(size =  0.75) +
  geom_abline(color = 'grey50', alpha = 0.5) +
  scale_x_continuous("White", limits = c(0, 0.5)) +
  scale_y_continuous("Black", limits = c(0, 0.5)) +
  theme(aspect.ratio = 1) 

p_hispanic_white <- freq_smrRace %>%
  pivot_wider(-count, names_from = labelled_race, values_from = SMR) %>%
  ggplot(aes(x = White, y = Hispanic)) +
  geom_point(size = 0.75) +
  geom_abline(color = 'grey50', alpha = 0.5) +
  scale_x_continuous("White", limits = c(0, 0.5)) +
  scale_y_continuous("Hispanic", limits = c(0, 0.5)) +
  theme(aspect.ratio = 1)

p_na_white <- freq_smrRace %>%
  pivot_wider(-count, names_from = labelled_race, values_from = SMR) %>%
  ggplot(aes(x = White, y = `NA`)) +
  geom_point(size = 0.75) +
  geom_abline(color = 'grey50', alpha = 0.5) +
  scale_x_continuous("White", limits = c(0, 0.5)) +
  scale_y_continuous("NA", limits = c(0, 0.5)) +
  theme(aspect.ratio = 1)

(p_asian_white | p_black_white )  / (p_hispanic_white | p_na_white )
ggsave("fig/smr_race.png")
rm(p_asian_white, p_black_white, p_hispanic_white, p_na_white)
```


```{r}
outcome_clean <- function(dataset, str_outcome){
  
    if(typeof(dataset[[str_outcome]]) == "character"){
      sym_outcome = sym(str_outcome)
      
      dataset <- dataset %>%
        mutate(!!sym_outcome := case_when(!!sym_outcome == "FALSE" ~ 0,
                                          !!sym_outcome == "TRUE" ~ 1,
                                          !!sym_outcome == "0" ~ 0,
                                          !!sym_outcome == "1" ~ 1))
    }
  
  return(dataset)
  
}

makeDF.RaceOutcome <- function(str_outcome, dataset_lst){
  
  sym_outcome <- sym(str_outcome)

  # 1. filter for 3 variables
  outcome_lst <- lapply(dataset_lst, myfilter_for, 
                        c("dataset_name", "subject_race", str_outcome), TRUE)
  outcome_lst <- outcome_lst[sapply(outcome_lst, function(x) isTRUE(nrow(x) > 0 ))]
  
  # 2. clean
  outcome_lst <- lapply(outcome_lst, outcome_clean, str_outcome)
  
  # 3. make df
  outcome_df <- data.frame(bind_rows(outcome_lst))
  
  # 4. numerator by counting total stops per outcome level and race group
  outcome_counts <- outcome_df %>% 
    group_by(dataset_name, subject_race, !!sym_outcome) %>%
    summarize(count = n(), .groups = "drop") %>%
    spread(key = !!sym_outcome, value = count)
  
  # 5. denominators and other relevant statistics
  
  # 5a. total stops per data set
  total_stops <- outcome_df %>% 
    group_by(dataset_name) %>% 
    summarize(total_stops = n(), .groups = "drop")
  
  # 5b. total stops per racial group
  total_stops_race <- outcome_df %>% 
    group_by(dataset_name, subject_race) %>% 
    summarize(total_stops_race = n(), .groups = "drop")
  
  # 5c. total stops NA (race and outcome)
  total_na_race <- total_stops_race %>% 
    filter(is.na(subject_race)) %>%
    rename(total_na_race = total_stops_race) %>%
    select(-subject_race)
  
  total_na_outcome <- outcome_counts %>% 
    group_by(dataset_name) %>%
    summarize(total_na_outcome = sum(`<NA>`, na.rm = TRUE), .groups = "drop")
  
  # 6. calculate rates
  all_rates <- outcome_counts %>%
    left_join(total_stops_race, by = c("dataset_name", "subject_race")) %>%
    # outcome == 1 denotes that the outcome happened
    # ex: search_conducted == 1 means that a search was conducted
    mutate(outcome_rate = `1` / total_stops_race,
           NA_outcome_rate = `<NA>` / total_stops_race) %>%
    select(dataset_name, subject_race, outcome_rate, NA_outcome_rate)
  
  outcome_rate <- all_rates %>%
    select(-NA_outcome_rate) %>%
    spread(key = subject_race, value = outcome_rate) %>%
    rename(`missing race` = `<NA>`)
  
  outcomeNA_rate <- all_rates %>%
    select(-outcome_rate) %>%
    spread(key = subject_race, value = NA_outcome_rate) %>%
    rename(`missing race` = `<NA>`)
  
  # 7b. join
  outcome_race_df <- outcome_rate %>%
    left_join(outcomeNA_rate, by = "dataset_name", suffix = c("", "NA")) %>%
    left_join(total_stops, by = "dataset_name") %>%
    left_join(total_na_race, by = "dataset_name") %>%
    mutate(total_na_race = ifelse(is.na(total_na_race), 0, total_na_race)) %>%
    left_join(total_na_outcome, by = "dataset_name") %>%
    mutate(outcome = paste(unlist(str_split(str_outcome, "_")), collapse = " "))
  
  return(outcome_race_df)
  
}

raceoutcomes_lst <- lapply(c("search_conducted"), 
                           makeDF.RaceOutcome, freq_dataset_lst)
```

```{r}

default.point <- list(geom_point(aes(size = `Total NA-race drivers`/`Total stops`, 
                                     color = log(`Total stops`))),
  geom_abline(),
  scale_x_continuous(limits = c(0, 0.4)),
  scale_y_continuous(limits = c(0, 0.4)),
  theme(aspect.ratio = 0.9,
        legend.key.height = unit(0.4, 'cm'), #change legend key height
        legend.key.width = unit(0.4, 'cm'),
        legend.title = element_text(size=9), #change legend title font size
        legend.text = element_text(size=9))) #change legend text font size))

bind_rows(raceoutcomes_lst) %>%
  select(outcome, black, white, `missing race`, total_stops, total_na_race) %>%
  gather(key = "race", value = "SMR", 2:3) %>%
  rename(`SMR for NA race drivers` = `missing race`,
         `Total stops` = total_stops, 
         `Total NA-race drivers` = total_na_race) %>%
  mutate(outcome = factor(outcome, levels = c("search conducted",
                                              "arrest made"))) %>%
  ggplot(aes(x = `SMR for NA race drivers`, y = `SMR`)) +
  default.point +
  facet_grid(outcome ~ race) +
  labs(subtitle = " ") +  
  theme(strip.placement = "outside") +
  labs(title = "Figure 6: Post-stop outcome rates for Black, white, and NA-race drivers",
       subtitle = "\nScatterplots for the search and arrest rates of Black and white drivers compared to NA-race drivers. \nThe search rate plots represents 32 datasets, while the arrest rate plots represent 33.")
```


## Missingness by date

## Missingness by time

# Descriptive Statistics 

# Missingness in `search_conducted`

```{r}
sc_dataset_lst <- lapply(dataset_lst, myfilter_for, c("search_conducted", "dataset_name"), TRUE)
sc_dataset_lst <- sc_dataset_lst[sapply(sc_dataset_lst, 
                                        function(x) isTRUE(nrow(x) > 0))]
```

```{r}
sum(unlist(lapply(sc_dataset_lst, function(x) sum(is.na(x))/dim(x)[1]))>= 0.2)

sapply(sc_dataset_lst, function(x) ifelse(sum(is.na(x))/dim(x)[1] >= 0.2, paste(x$dataset_name, as.character(dim(x)[1])), "nah"))
```

# Missingness in `arrest_made`

```{r}
ar_dataset_lst <- lapply(dataset_lst, myfilter_for, c("arrest_made", "dataset_name"), TRUE)
ar_dataset_lst <- ar_dataset_lst[sapply(ar_dataset_lst, 
                                        function(x) isTRUE(nrow(x) > 0))]
```

```{r}
hist(unlist(lapply(ar_dataset_lst, function(x) sum(is.na(x))/dim(x)[1])))


```

```{r}
unlist(lapply(ar_dataset_lst, function(x) sum(is.na(x))/dim(x)[1]))
```


# Missingness in `driver_race`

```{r}
race_dataset_lst <- lapply(dataset_lst, myfilter_for, c("subject_race", "dataset_name"), TRUE)
race_dataset_lst <- race_dataset_lst[sapply(race_dataset_lst, 
                                        function(x) isTRUE(nrow(x) > 0))]
```

```{r}
hist(unlist(lapply(race_dataset_lst, function(x) sum(is.na(x))/dim(x)[1])))


```

```{r}
sum(unlist(lapply(race_dataset_lst, function(x) sum(is.na(x))/dim(x)[1]))>= 0.2)

sapply(race_dataset_lst, function(x) ifelse(sum(is.na(x))/dim(x)[1] >= 0.2, paste(x$dataset_name, as.character(dim(x)[1])), "nah"))
```

```{r}
lapply(dataset_lst, function(x) names(x))
```

